name: Sync to Google Drive

on:
  push:
    branches: [ main ]

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Zip Project
        run: zip -r production_app.zip . -x ".git*"

      - name: Upload to Google Drive via GAS
        env:
          WEBAPP_URL: ${{ secrets.WEBAPP_URL }}
        run: |
          python3 - <<EOF
          import json, urllib.request, os, base64
          
          # ファイルを読み込んでBase64にする
          with open("production_app.zip", "rb") as f:
              b64 = base64.b64encode(f.read()).decode()
          
          # JSONデータを作成
          payload = json.dumps({
              "filename": "production_app.zip",
              "mimetype": "application/zip",
              "base64": b64
          }).encode()
          
          # JSON形式で送信
          req = urllib.request.Request(
              os.environ["WEBAPP_URL"], 
              data=payload, 
              headers={'Content-Type': 'application/json'}
          )
          
          try:
              with urllib.request.urlopen(req) as res:
                  print(res.read().decode())
          except Exception as e:
              print(f"エラーよ: {e}")
              exit(1)
          EOF
